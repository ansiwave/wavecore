from ./wavecorepkg/db import nil
from ./wavecorepkg/db/entities import nil
from ./wavecorepkg/db/db_sqlite import nil
from ./wavecorepkg/server import nil
from ./wavecorepkg/db/vfs import nil
from os import joinPath
from osproc import nil

const
  port = 3000
  address = "http://localhost:" & $port

const ansiArt =
  """
[0;37;40m/instrument [0;1;22;37;40melectric-g[0;22;1;37;40mui[0;1;22;37;40mtar-d[0;22;1;37;40mis[0;1;22;37;40mtorted[0;40;1;22;36mâ–€â–„â–ˆâ–ˆâ–ˆâ–ˆâ–„â–€â–€â–„ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–€â–„ â–€â–„â–ˆ â–„â–„ â–ˆ[1;30mâ–ˆ[22;36mâ–„   [1;30mâ–Œ    â–€â–„    [0m
[0;40mâ–ˆâ–€â–„    â–€â–„â–ˆ â–„â–„â–€ [22;36mâ–ˆâ–ˆ [1;30mâ–ˆ [22;36mâ–ˆ [1;30mâ–Œ[22;36mâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–„[1;30mâ–€â–„[22;36mâ–€ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ[1;30mâ–ˆ[22;36mâ–ˆâ–ˆ  [1;30mâ–ˆ    â–€â–„    [0m
[0;40mâ–„â–€       â–€â–„â–ˆ  â–€â–„[22;36mâ–€ [1;42;30mâ–ˆ[40m [22;36mâ–ˆ [1;30mâ–Œ[22;36mâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„[1;30mâ–€â–„[22;36mâ–€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–Œâ–ˆâ–ˆâ–ˆâ–ˆ[1;30mâ–ˆ[22;36mâ–ˆâ–ˆ â–ˆâ–„[1;30mâ–€â–„  â–€â–„    [0m
[0;40m         â–€â–„â–ˆâ–€â–„  â–€â–„[42mâ–ˆ[40m [22;36mâ–ˆ [1;30mâ–Œ[22;36mâ–ˆâ–ˆ â–ˆ[1;46mâ–€â–„â–€â–„[22;40mâ–ˆâ–ˆâ–ˆ [1;30mâ–€â–„[22;36mâ–€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆâ–ˆ [1;30mâ–ˆ â–€â–„    [0m
[0;40m        â–€â–„â–ˆ[42mâ–„[40mâ–€â–„â–ˆ  [22;36mâ–„[1;30mâ–€â–„[22;36mâ–€â–ˆâ–„â–ˆâ–€â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–„[1;30mâ–€â–„[22;36mâ–€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ[1;46mâ–€â–„  [22;40mâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ[1;30mâ–ˆ[22;36mâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–„[1;30mâ–€â–„     [0m
[0;40m         â–ˆâ–€â–„â–€[42mâ–€â–„[40m  [22;36mâ–ˆâ–ˆâ–„ [1;30mâ–„â–„ [22;36mâ–„â–ˆâ–ˆâ–ˆâ–ˆ[1;46mâ–€â–„â–€â–„[22;40mâ–ˆ â–ˆâ–ˆâ–ˆâ–„[1;30mâ–€â–„[22;36mâ–€[1;46mâ–€â–„[22;40mâ–ˆâ–ˆâ–ˆâ–Œâ–ˆâ–ˆâ–ˆâ–ˆ[46m [1mâ–€â–„[22;40mâ–ˆâ–ˆâ–ˆâ–„â–€â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–„â–€â–€â–ˆâ–„ [1;30mâ–€â–„â–„â–„ [0m
[0;40m       â–€â–„â–ˆâ–ˆ â–„â–€[22;36mâ–„â–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–„â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„[1;30mâ–€â–„[22;36mâ–€â–ˆ[1;46mâ–„â–€â–„â–€â–„[22;40mâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ[1;46mâ–€â–„[22;40mâ–ˆâ–„â–€â–€â–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–€â–€â–„[1;30mâ–€â–„   â–€[0m
[0;40m       â–€â–„â–ˆâ–€â–ˆ [22;36mâ–ˆ[1;46mâ–„[22;40mâ–ˆ [1;46mâ–€[22;40mâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ[1;46mâ–€â–„â–€â–„[22;40mâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ[1;46mâ–€â–„â–€â–„[22;40mâ–„[1;30mâ–€â–„[22;36mâ–€[1;46mâ–€â–„â–„â–€â–ˆâ–„â–€â–„[22;40mâ–ˆ[1;46mâ–€â–„â–€â–„â–„â–€[22;40mâ–ˆâ–ˆâ–ˆ â–„â–„â–„â–„â–„â–ˆâ–ˆâ–ˆâ–„      [0m
[0;37;40m/play /16[0;40m [0;37;40md[0;40m [0;37;40md[0;40m [0;30;46md /3[0;46m [0;30;46mg[0;46m [0;30;46md+[0;1;22;30;46m /16 c[0;22;1;30;46m+ [0;1;22;30;46mb a[0;36;1;22;40m [30;46m/[0;22;1;30;46m3 g+ d+[0;36;22;1;46mâ–„[22;40mâ–„[1;30mâ–€â–„[22;36mâ–€[1;46mâ–„[40mâ–ˆâ–€[33mâ–„â–„[22;36mâ–€[32mâ–„[1;36mâ–€[32mâ–„â–„[22;36mâ–€[1;32mâ–„[22;36mâ–€â–ˆ[1;46mâ–€â–„[40m [22mâ–ˆâ–ˆâ–ˆ[1;46mâ–€â–„[22;40mâ–ˆâ–ˆâ–ˆâ–„      [0m
[0;40m        [1;30mâ–ˆâ–ˆâ–ˆâ–€â–„ [46;36mâ–„â–€[22;40mâ–„[1;46mâ–€â–„ â–„â–€â–„[22;40mâ–ˆ[1;46mâ–€[22;40mâ–ˆ[1;46mâ–€â–„[22;40mâ–ˆ[1;46mâ–„[22;40mâ–ˆ[1;46mâ–„â–€[40m [22mâ–ˆ[1;46mâ–€â–„â–€â–„â–„â–€â–€â–„ â–„[22;40mâ–ˆâ–„[1;30mâ–€â–„[36mâ–€[22m [1;43;31mâ–„â–„[33mâ–€[22;40;32mâ–€[42;30mâ– â–  [40;32mâ–€[36mâ–„[1;46mâ–„â–€[22;40mâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      [0m
[0;37;40m/play /1[0;1;37;40m6[0;1;22;37;40m c+ b[0;1;22;30;46m [0;22;1;30;46ma[0;22;36;1;46mâ–„[22;40mâ–„â–€[1;30;46m/[0;22;1;30;46m3 g+ d+[0;1;22;30;46m [0;22;1;30;46m/16[0;36;1;22;40mâ–€â–„[1;30;46mc[0;22;1;30;46m+ b c+ /3 [0;1;22;30;46ma[0;36;22;1;46mâ–„â–€â–„[40m [31mâ–„ [22;33mâ–„[43;32mâ–„[1;40mâ–„[30mâ–„â–„â–€â–ˆâ–Œ[46;36mâ–€â–„â–€â–„[22;40mâ–ˆ â–ˆâ–ˆ[1;46mâ–€â–„â–€â–„[22;40mâ–€â–„â–€ [1;30mâ–€â–„   [0m
[0;40m        â–€â–„â–ˆ[43mâ–€â–„[40mâ–ˆ[22;36mâ–€[1;46mâ–€â–„[22;40mâ–ˆ[1;46mâ–„[22;40mâ–„â–€â–€â–ˆ[1;46mâ–€â–„â–€â–„â–€[22;40mâ–€â–€â–„[1;46mâ–„â–€â–„[22;40mâ–ˆ[1;46mâ–„â–€â–„â–€â–„â–€â–„[22;40mâ–ˆâ–ˆ[1;46mâ–€â–„â–€â–„[40m [31mâ–Œ[43mâ–„[47mâ–€[37mâ–ˆ[22;40mâ–ˆ [1;30mâ–€â–ˆâ–„ [46;36mâ–€â–„[22;40mâ–ˆâ–ˆâ–ˆâ–ˆâ–€â–ˆâ–ˆâ–ˆâ–ˆâ–„â–€â–„ [1;30mâ–€â–„â–„   [0m
[0;37;40m/play /16 d d[0;46mâ–ˆ[37;40m [0;30;46m/3 e [0;22;30;46m/[0;22;1;30;46m8[0;1;22;30;46m e c[0;22;1;30;46m+[0;1;22;30;46m [0;22;1;30;46mb[0;1;22;30;46m [0;22;1;30;46ma  g  [0;1;22;30;46m [0;22;1;30;46m [0;1;22;30;46m [0;22;1;30;46m  [0;36;1;22;40mâ–ˆâ–ˆ[1;46mâ–€â–„[22;40mâ–€[33mâ–„[36mâ–€ [33mâ–€ [37mâ–„[1;43mâ–„â–„[22;40;32mâ–Œâ–ˆâ–€[1;36mâ–„[46mâ–€â–„â–€â–„[22;40mâ–ˆ[1;46mâ–€â–„[22;40mâ–„â–€[1;46mâ–€â–„[22;40mâ–€[1;46mâ–€[22;40mâ–€ [1;30mâ–€â–„â–€â–„â–€â–„ [0m
[0;40m        â–€â–„â–€â–„[46mâ–ˆ[43mâ–„[40mâ–€â–„[22;36mâ–€[1;46mâ–€â–„â–„â–€â–„â–€[22;40mâ–ˆ[1;46mâ–„â–€â–„â–€â–„â–€â–„[22;40mâ–ˆ[1;46mâ–„â–€[22;40mâ–ˆâ–ˆ[1;46mâ–„â–€â–„â–€â–„â–€[22;40mâ–ˆ[1;46mâ–„[22;40mâ–ˆâ–„[33mâ–€â–€[37mâ–€ [1;47mâ–€[22;40mâ–€â–€[36mâ–„â–„ [1;30mâ–„[22;36mâ–€[1;46mâ–€â–„[22;40mâ–ˆ[1;46mâ–€â–„â–„[22;40mâ–ˆ[1;46mâ–€â–„[22;40mâ–„â–€[1;46mâ–„[40m [30mâ–€â–„â–€â–„â–€â–„â–€â–„ [0m
[0;37;40m/play /16 g a b  [0;40mâ–„[22;36mâ–€[1mâ–€[30;46m/[0;22;1;30;46m3 a[0;22;36;1;46mâ–„[30;46m/[0;22;1;30;46m8 e f# /8  d d /3 e[0;22;36;1;46mâ–„â–€[22;40mâ–€[33mâ–„â–ˆ[36mâ–„[1;46mâ–€â–„â–€â–„â–€[22;40mâ–„[1;30mâ–€â–„[22;36mâ–€[1;46mâ–ˆâ–„â–€â–„â–ˆâ–€â–„[22;40mâ–€[1;46mâ–„[40m [30mâ–€â–„â–€â–„ â–€â–„  â–„[0m
[0;40m       â–€â–„â–€â–„ â–€ â–ˆâ–€â–„ â–€â–ˆâ–„[36mâ–€[46mâ–„[40mâ–ˆâ–ˆ[46mâ–„â–„â–€â–€â–„[40mâ–ˆâ–ˆâ–„[22mâ–€[1;30mâ–„[22;36mâ–€[1;46mâ–€â–„â–ˆâ–ˆâ–€â–ˆâ–ˆâ–ˆâ–€â–„[22;40mâ–ˆ[1;46mâ–„[22;40mâ–„â–„[1;46mâ–„â–€â–ˆâ–„â–ˆâ–€â–„[22;40mâ–„[1;30mâ–€â–„[22;36mâ–€[1;46mâ–€â–ˆâ–„â–€â–„â–ˆ[40mâ–€ [30mâ–€â–„ â–€  â–€â–„â–„â–€ [0m
[0;37;40m/play /8 e c+ b a[0;40mâ–€[37;40mg[0;40mâ–„[37;40md[0;37;40m+[0;40mâ–„[30;46m/[0;30;46m2 a[0;40;36mâ–€â–„â–€â–„â–€ [30mâ–„â–€[36mâ–„â–€â–ˆâ–€â–ˆâ–€â–ˆâ–ˆ[46mâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„[22;40mâ–„[1;30mâ–€â–„[22;36mâ–€[1;46mâ–€â–„[40mâ–€  [30mâ–€â–„       â–„â–€â–„[0m
[0;40m     â–€    â–€  â–€â–„  â–„ â–€â–ˆâ–ˆâ–„â–ˆ [36mâ–€â–„â–€â–€ â–„ â–€[30mâ–„â–€â–„â–€ â–€â–„â–€ [36mâ–€â–ˆâ–€â–„â–€â–„â–ˆâ–ˆâ–ˆâ–€â–€â–„â–€â–„â–ˆâ–ˆâ–ˆâ–€â–ˆâ–„â–ˆâ–€â–ˆâ–€ [30mâ–€â–„         â–€â–„[0m
[0;40m                   â–€â–ˆ â–€ â–€â–„   â–„ â–„â–€â–„â–€ â–ˆâ–„â–€â–„â–€â–„â–€ â–„ [36mâ–€â–€ â–€ â–€ â–€â–€ â–€â–€ â–€ â–€ â–€   [30mâ–€â–„    â–€â–„â–€â–„ â–„ [0m
[0;40m    â–„ â–„â–€â–„â–€â–„â–„â–„â–ˆâ–€â–„â–ˆâ–ˆâ–ˆ[43mâ–„[46mâ–ˆ[43mâ–€â–„â–€[46mâ–ˆ[43mâ–„â–„[46mâ–ˆâ–ˆ[43mâ–„[46mâ–ˆâ–ˆ[40mâ–„[46mâ–ˆ[40mâ–ˆâ–ˆ[46mâ–„â–„[43mâ–ˆ[46mâ–€â–„[40mâ–„â–„â–€â–„â–€â–„â–€â–„â–ˆâ–ˆâ–„â–„â–„ â–„ â–„ â–„â–„â–ˆâ–ˆâ–ˆâ–ˆ[43mâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ[40mâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ[0m
[0;40m           â–€â–€â–„   â–€â–„â–€â–„â–€â–„â–€â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„â–ˆâ–ˆ[42mâ–ˆâ–ˆâ–ˆ[40mâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ[46mâ–„â–„[40mâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ[47mâ–„â–„[40mâ–ˆâ–ˆ[47mâ–„[40mâ–ˆâ–ˆâ–ˆâ–ˆâ–€â–„â–€â–„â–€â–„[0m
[0;40m       â–€ â–€â–„â–€â–€â–„â–€â–ˆâ–€â–„â–€â–„â–€â–„â–€â–ˆâ–„â–„â–€â–„â–€â–„â–€â–ˆâ–€â–„â–€â–ˆâ–€â–„â–ˆâ–ˆâ–€â–„ â–€â–„â–€â–„â–€â–ˆâ–€â–„â–€â–„â–€â–„â–€â–„â–€â–„â–€â–„â–€â–„â–€â–„â–€â–„â–€â–„â–€â–„â–€â–„â–€â–„ â–„ â–„ [0m
[0;40m                            â–€ â–€â–„â–€ â–€â–„â–€â–„â–€â–„â–€ â–€â–„â–€ â–€ â–€â–„â–€â–„â–€â–„â–€â–„â–„â–€â–„â–€â–„â–€â–„â–€ â–€  â–„  â–€   â–€   â–€[0m
[0;40m                â–€   â–  â–€â–„â–€â–„â–€ â–€â–„â–€ â–€ â–€â–„â–€â–„â–€â–„â–€â–„â–„â–€â–„â–€â–„â–€â–„â–€â–„ â–€ â–„ â–€â–„â–„â–€â–„â–€ â–€â–„â–€â–„â–€â–„â–€â–„â–€â–„â–€â–„â–€ â–€ â–€[0m
[0;40mâ†’SAUCE00                                                                        [0m
[0;40m   201701015â–º  â˜ºâ˜ºP â†‘      â€¼IBM VGA                                              [0m

  """

let
  staticFileDir = "tests".joinPath("bbs")
  dbPath = staticFileDir.joinPath(server.dbFilename)

when isMainModule:
  vfs.register()
  var s = server.initServer("localhost", port, staticFileDir)
  server.start(s)
  # create test db
  discard osproc.execProcess("rm " & dbPath & "*")
  var conn = db.open(dbPath)
  db.init(conn)
  db_sqlite.close(conn)
  var p1 = entities.Post(parent_id: 0, user_id: 0, body: db.CompressedValue(uncompressed: ansiArt))
  p1.id = server.insertPost(s, p1)
  var
    alice = entities.User(username: "Alice")
    bob = entities.User(username: "Bob")
  alice.id = server.insertUser(s, alice)
  bob.id = server.insertUser(s, bob)
  for i in 1..500:
    var p2 = entities.Post(parent_id: p1.id, user_id: bob.id, body: db.CompressedValue(uncompressed: "Hello, i'm bob"))
    p2.id = server.insertPost(s, p2)
    var p3 = entities.Post(parent_id: p2.id, user_id: alice.id, body: db.CompressedValue(uncompressed: "What's up"))
    p3.id = server.insertPost(s, p3)
  discard readLine(stdin)
  server.stop(s)
